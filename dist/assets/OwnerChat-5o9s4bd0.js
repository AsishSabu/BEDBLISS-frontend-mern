import{s as P,r as t,U,q as W,j as e,p as D,v as O,O as C,S as G,T as q}from"./index-G4O_8HcF.js";import{u as I,v as M}from"./Notifications-N6mrlI2l.js";import{M as V}from"./Messages-Hw-ui_Y1.js";import{a as B}from"./hoist-non-react-statics.cjs-a0QTsczJ.js";import"./Pagination-dCx4FqSh.js";import"./tslib.es6-DuO2G4rp.js";import"./clsx-B-dksMZM.js";const H=({members:l,userId:g})=>{const s=P(a=>a.chatSlice),[u,i]=t.useState(null);t.useEffect(()=>{s&&i(s.currentChat)},[s]);const p=s.currentChat,m=l.find(a=>a!==g),{data:x,isError:h}=I(m?`${U}/user/${m}`:""),[N,n]=t.useState(0),c=W();return t.useEffect(()=>{const a=({count:v,senderId:j,chatId:b})=>{console.log(p,"current"),console.log(j,"chat id"),l.includes(j)&&(u?u._id!==b?n(w=>w+v):n(0):n(w=>w+v))};return c==null||c.on("msgCount",a),()=>{c==null||c.off("msgCount",a)}},[]),h?e.jsx("div",{children:"Failed to load"}):x?e.jsx("div",{children:e.jsx("div",{className:"conversation-item p-1 dark:bg-gray-700 bg-varBlueGray hover:bg-gray-200 m-1 rounded-md ",children:e.jsxs("div",{className:"flex items-center p-2  cursor-pointer  ",children:[e.jsx("div",{className:"w-7 h-7 m-1",children:e.jsx("img",{className:"w-7 h-7 rounded-full",src:x.user.profilePic?x.user.profilePic:M,alt:x.user.name||"User"})}),e.jsxs("div",{className:"flex-grow p-2",children:[e.jsxs("div",{className:"flex justify-between text-md ",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:x.user.name||"User"}),e.jsx("div",{className:"text-xs text-gray-400 dark:text-gray-300",children:"dfsdf"})]}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400  w-40 truncate",children:"dsad"}),e.jsx("span",{children:N})]})]})})}):e.jsx("div",{children:"Loading..."})},J=({chats:l,handleCurrentChatClick:g,currentChat:s})=>{const u=P(i=>i.userSlice);return e.jsx("div",{children:l.map(i=>e.jsx("div",{onClick:()=>g(i),children:e.jsx(H,{...i,userId:(u==null?void 0:u.id)??"",currentChat:s})},i._id))})},re=()=>{const[l,g]=t.useState([]),[s,u]=t.useState(null),[i,p]=t.useState([]),[m,x]=t.useState(""),[h,N]=t.useState(null),n=W(),c=t.useRef(null),a=D(r=>r.userSlice),[v,j]=t.useState(!1),[b,w]=t.useState(""),[E,_]=t.useState(!1),[f,z]=t.useState(null),T=O(),{data:k}=I(`${C}/conversations`),{data:y}=I(s?`${C}/messages/${s._id}`:"");t.useEffect(()=>{T(G())},[]),t.useEffect(()=>{n==null||n.on("getMessage",r=>{N({senderId:r.senderId,text:r.text,createdAt:Date.now()}),n==null||n.on("senderTyping",(o,d)=>{d&&w(d),j(!!o)})})},[]),t.useEffect(()=>{if(h){const r=l.findIndex(o=>o.members.includes(h.senderId));if(r!==-1){const o=[...l],[d]=o.splice(r,1);o.unshift(d),g(o),(s==null?void 0:s._id)===d._id&&p(S=>[...S,h])}else g(o=>[{members:[a.id,h.senderId],_id:"new_conversation"},...o]);N(null)}},[h,s,l,a.id]),t.useEffect(()=>{if(n)return n.on("connect",()=>{console.log("connected to socket")}),n.emit("addUser",a.id),n.on("getUsers",r=>{console.log(r)}),()=>{n.off("getUsers")}},[n]),t.useEffect(()=>{k&&(console.log(l,"................................................"),g(k))},[k]),t.useEffect(()=>{y&&p(y==null?void 0:y.message)},[y]),console.log(i);const L=t.useMemo(()=>s==null?void 0:s.members.find(r=>r!==a.id),[s,a.id]),A=r=>{n==null||n.emit("typing",{receiverId:L,isTyping:r,userId:a.id})},$=r=>A(r==="focus"),F=async r=>{if(r.preventDefault(),m.trim()==="")return;n==null||n.emit("sendMessage",{senderId:a.id,receiverId:L,text:m,chatId:s==null?void 0:s._id});const o={senderId:a.id,conversationId:s==null?void 0:s._id,text:m};try{const d=await B.post(`${C}/messages`,o);p(S=>[...S,d.data]),x("")}catch(d){console.error(d)}};t.useEffect(()=>{s&&(async()=>{try{console.log(s,"current chat");const o=s==null?void 0:s.members.find(d=>d!==a.id);if(o){const d=await B.get(U+"/user/"+o);z(d.data.user),console.log(d,"response")}}catch(o){console.error("Error fetching sender info:",o)}})()},[s,a.id]),console.log(f,"sender iNfooo"),t.useEffect(()=>{var r;(r=c.current)==null||r.scrollIntoView({behavior:"smooth"})},[i,v]);const R=r=>{T(q(r)),u(r),_(!0)};return console.log(s,"current chat ðŸ˜ƒ"),e.jsx("div",{className:" pt-2",children:e.jsxs("div",{className:"flex bg-white dark:bg-gray-900 p-5",children:[e.jsx("div",{className:` h-screen bg-varGrey border shadow-md p-2 ${E?"hidden md:block w-80":"md:block w-full md:w-80"}`,children:e.jsxs("div",{className:"h-full  overflow-y-auto",children:[e.jsxs("div",{className:"text-xl font-extrabold mb-4 flex gap-3 text-gray-600 border rounded-md shadow-md dark:text-gray-200 p-3",children:[e.jsx("img",{className:"w-10 h-10  rounded-full",src:a&&a.image?a.image:M,alt:"Avatar"}),a.name]}),e.jsx(J,{chats:l,currentChat:s,handleCurrentChatClick:R})]})}),e.jsx("div",{className:`flex-grow h-svh p-2 rounded-md ${E?"md:block":"md:block hidden"}`,children:s?e.jsxs(e.Fragment,{children:["          ",e.jsxs("div",{className:"flex-grow h-full flex flex-col",children:[e.jsx("div",{className:"w-full h-15 p-1 bg-varBlue dark:bg-gray-800 shadow-md rounded-xl rounded-bl-none rounded-br-none",children:e.jsxs("div",{className:"flex p-2 align-middle items-center",children:[e.jsx("div",{onClick:()=>_(!1),className:"p-2 md:hidden rounded-full mr-1 hover:bg-purple-500 text-white",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})})}),e.jsx("div",{className:"border rounded-full border-white p-1/2",children:e.jsx("img",{className:"w-14 h-14 rounded-full",src:(f==null?void 0:f.profilePic)||M,alt:"avatar"})}),e.jsxs("div",{className:"flex-grow p-2",children:[e.jsx("div",{className:"text-md text-gray-50 font-semibold",children:f&&(f==null?void 0:f.name)}),e.jsx("div",{className:"flex items-center",children:e.jsx("div",{className:" text-varWhite ml-1",children:v&&(s!=null&&s.members.includes(b))?"Typing...":""})})]}),e.jsx("div",{className:"p-2 text-white cursor-pointer hover:bg-purple-500 rounded-full",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})})]})}),e.jsx("div",{className:"w-full flex-grow no-scrollbar my-2 p-2 overflow-y-auto",children:i.map(r=>e.jsx("div",{ref:c,children:e.jsx(V,{message:r,own:r.senderId===a.id})},r._id))}),e.jsx("div",{className:"h-15  p-3 rounded-xl rounded-tr-none rounded-tl-none bg-gray-100 dark:bg-gray-800",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"p-2 text-gray-600 dark:text-gray-200 ",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{className:"search-chat flex flex-grow p-2",children:[e.jsx("input",{className:"input text-gray-700 dark:text-gray-200 text-sm p-5 focus:outline-none bg-gray-100 dark:bg-gray-800  flex-grow rounded-l-md",type:"text",placeholder:"Type your message ...",onChange:r=>x(r.target.value),value:m,onBlur:()=>$("blur"),onFocus:()=>$("focus")}),m?e.jsx("div",{onClick:F,className:"bg-gray-100 dark:bg-gray-800 dark:text-gray-200  flex justify-center items-center pr-3 text-gray-400 rounded-r-md",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})}):""]})]})})]})]}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"flex justify-center bg-gray-200 h-full",children:e.jsx("p",{className:"text-2xl pt-56  ",children:"Please Select A Chat to Start Converstion"})})})})]})})};export{re as default};
